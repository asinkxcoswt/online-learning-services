name: "Terraform CI"

on:
  - pull_request

jobs:
  terraform-plan:
    name: "Terraform Plan (PR)"
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Terraform Init
        run: terraform init -input=false

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan (save to file)
        id: plan
        run: |
          terraform plan -no-color -input=false -out=plan.tfplan
          terraform show -no-color plan.tfplan > plan.txt
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: ${{ env.TF_WORKING_DIR }}/plan.txt

      - name: Post plan to PR
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### Terraform Plan for `${{ github.head_ref }}` ➡️ `${{ github.base_ref }}`
            > Generated by workflow: `${{ github.workflow }}`

            <!-- Plan output -->
            ```diff
            ${{ steps.plan.outputs.plan || '' }}
            ```
            **Artifact:** the full plan is uploaded as `tfplan` artifact (file: plan.txt).

      # Optional: keep plan content as an output (some runners disallow large outputs).
      - name: Set plan output (short)
        run: echo "plan<<EOF" >> $GITHUB_OUTPUT && sed -n '1,200p' plan.txt >> $GITHUB_OUTPUT && echo "EOF" >> $GITHUB_OUTPUT
        shell: bash
